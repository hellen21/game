package cr.fi.grupomutual.website.controllers;

import groovy.util.logging.Log4j;

import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.mobile.device.Device;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import cr.fi.grupomutual.website.entities.PromotionsWsResponse.PromotionResponse.Promotion;
import cr.fi.grupomutual.website.entities.Structure.ConsultStructureSiteMsjRestType.Section;
import cr.fi.grupomutual.website.entities.ContentPage;
import cr.fi.grupomutual.website.entities.ContentSection;
import cr.fi.grupomutual.website.entities.MatchContent;
import cr.fi.grupomutual.website.entities.Rate;
import cr.fi.grupomutual.website.entities.Structure;
import cr.fi.grupomutual.website.entities.ContentSection.ConsultSectionContentMsjRespType;
import cr.fi.grupomutual.website.entities.locations.Canton;
import cr.fi.grupomutual.website.entities.locations.Canton.ConsultarCantonMsjRespTipo.ListaCanton;
import cr.fi.grupomutual.website.entities.locations.Category.ConsultarCategoriasPuntoDeInteresMsjRespTipo.ListaCategoriaPuntoInteres;
import cr.fi.grupomutual.website.entities.locations.District;
import cr.fi.grupomutual.website.entities.locations.District.ConsultarDistritoMsjRespTipo.ListaDistrito;
import cr.fi.grupomutual.website.entities.locations.InterestPoints.ConsultarPuntosDeInteresMsjRespTipo.ListaPuntoInteres;
import cr.fi.grupomutual.website.entities.locations.Province;
import cr.fi.grupomutual.website.entities.locations.Province.ConsultarProvinciaMsjRespTipo.ListaProvincia;
import cr.fi.grupomutual.website.services.NearMeService;
import cr.fi.grupomutual.website.utilities.Utils;
import cr.fi.grupomutual.website.ws.HomeWsClient;
import cr.fi.grupomutual.website.ws.SectionWsClient;

/**
 * Controller to handle find us section requests
 * 
 * @author cvargas-as Avantica Technologies
 */

@Log4j
@Controller
public class NearMeController extends Utils {

	protected static final String ATTRIBUTE_APIKEY = "apiKey";
	protected static final String ATTRIBUTE_CANTONS = "cantons";
	protected static final String ATTRIBUTE_CATEGORIES = "categories";
	protected static final String ATTRIBUTE_DISTRICTS = "districts";
	protected static final String ATTRIBUTE_PROVINCES = "provinces";
	protected static final String ATTRIBUTE_ZOOM = "zoom";

	protected static final String METHOD_GET_CANTONS = "/nearme/getCantons";
	protected static final String METHOD_GET_DISTRICTS = "/nearme/getDistricts";
	protected static final String METHOD_GET_INTEREST_POINTS = "/nearme/getInterestPoints";
	protected static final String METHOD_GET_INTEREST_POINTS_WITH_LOCATIONS = "/nearme/getInterestPointsWithLocations";
	protected static final String METHOD_GET_PROMOTIONS = "/nearme/getPromotions";
	protected static final String METHOD_GET_PROVINCES = "/nearme/getProvinces";
	protected static final String METHOD_NEARME = "/cercaDeMi";

	protected static final String PARAMETER_CANTON_ID = "cantonId";
	protected static final String PARAMETER_DISTRICT_ID = "districtId";
	protected static final String PARAMETER_LATITUDE = "latitude";
	protected static final String PARAMETER_LONGITUDE = "longitude";
	protected static final String PARAMETER_PROVINCE_ID = "provinceId";

	protected static final String VIEW_NEARME = "nearme";

	Logger fileLog = Logger.getLogger("file");
	@Autowired
	private NearMeService nearMeService;

	@Autowired
	HomeWsClient homeWsClient;
	
	@Autowired
	SectionWsClient sectionWsClient;

	@Autowired
	Utils util;

	@Value("${googlemaps.apiKey}")
	private String MAPS_API_KEY;
	@Value("${googlemaps.zoom}")
	private String MAPS_ZOOM;

	@RequestMapping(value = METHOD_GET_CANTONS)
	public @ResponseBody List<ListaCanton> getCantons(
			@RequestParam(value = PARAMETER_PROVINCE_ID) String provinceId) {
		Canton response = null;
		try {
			response = nearMeService.getCantonsData(provinceId);
		} catch (RuntimeException e) {
			e.printStackTrace();
			fileLog.error("Canton error " + e.toString());
		}
		return response.getConsultarCantonMsjRespTipo().getListaCanton();
	}

	@RequestMapping(value = METHOD_GET_DISTRICTS)
	public @ResponseBody List<ListaDistrito> getDistricts(
			@RequestParam(value = PARAMETER_CANTON_ID) String cantonId,
			@RequestParam(value = PARAMETER_PROVINCE_ID) String provinceId) {

		District response = null;
		try {
			response = nearMeService.getDistrictsData(cantonId, provinceId);
		} catch (RuntimeException e) {
			// TODO Auto-generated catch block
			fileLog.error("District error " + e.toString());
			e.printStackTrace();
		}
		return response.getConsultarDistritoMsjRespTipo().getListaDistrito();
	}

	@RequestMapping(value = METHOD_GET_INTEREST_POINTS)
	public @ResponseBody List<ListaPuntoInteres> getInterestPoints(
			@RequestParam(value = PARAMETER_LATITUDE) String latitude,
			@RequestParam(value = PARAMETER_LONGITUDE) String longitude) {

		try {
			return nearMeService.getInterestPoints(latitude, longitude);
		} catch (RuntimeException e) {
			// TODO Auto-generated catch block
			fileLog.error("IterestPoints error " + e.toString());
			e.printStackTrace();
		}
		return null;
	}

	@RequestMapping(value = METHOD_GET_INTEREST_POINTS_WITH_LOCATIONS)
	public @ResponseBody List<ListaPuntoInteres> getInterestPointsWithLocations(
			@RequestParam(value = PARAMETER_PROVINCE_ID) String provinceId,
			@RequestParam(value = PARAMETER_CANTON_ID) String cantonId,
			@RequestParam(value = PARAMETER_DISTRICT_ID) String districtId) {

		try {
			return nearMeService.getInterestPoints(provinceId, cantonId,
					districtId);
		} catch (RuntimeException e) {
			// TODO Auto-generated catch block
			fileLog.error("InterestPoitLocations error " + e.toString());
			e.printStackTrace();
		}
		return null;
	}

	@RequestMapping(value = METHOD_GET_PROMOTIONS)
	public @ResponseBody List<Promotion> getPromotions(@RequestParam(value = PARAMETER_LATITUDE) String latitude,
															   @RequestParam(value = PARAMETER_LONGITUDE) String longitude){
 
		try {
			return nearMeService.getPromotions();
		} catch (RuntimeException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} 
		return null;
	}	@RequestMapping(value = METHOD_GET_PROVINCES)
	public @ResponseBody List<ListaProvincia> getProvinces() {
		Province response = null;
		try {
			response = nearMeService.getProvincesData();
		} catch (RuntimeException e) {
			// TODO Auto-generated catch block
			fileLog.error("GetProvinces error " + e.toString());
			e.printStackTrace();
		}
		return response.getConsultarProvinciaMsjRespTipo().getListaProvincia();
	}

	@RequestMapping(value = METHOD_NEARME)
	public String nearme(Model map, HttpServletRequest request, Device device) {
		boolean isTablet = device.isTablet();
		map.addAttribute("device", isTablet);
		String company = (String) request.getSession().getAttribute("company");
		boolean noMain = false;
		if(company == null){
			company="1";
			noMain = true;
		}
		
		List<ListaCategoriaPuntoInteres> categoriesList = null;
		List<Promotion> promotions = nearMeService.getPromotions();
		try {
			categoriesList = nearMeService.getCategoriesData();
		} catch (RuntimeException e) {
			// TODO Auto-generated catch block
			fileLog.error("Nearme error " + e.toString());
			e.printStackTrace();
		}
		Rate rate = null;
		// Call the service RateChange, to get the rate change value
		try {
			rate = homeWsClient.getRateChangeValue();
			if(noMain){
				 String resp = showHome(company);
				 MatchContent contentMath=util.searchMath(resp);
				 ContentPage contentPage = util.generatePage(company, resp, contentMath.getSliderList(), contentMath.getCasillaList(), contentMath.getCarouselList());
			 }
		} catch (Exception e) {
			fileLog.error("Rate error " + e.toString());
			rate = new Rate();
			rate.setAmmountBuy("0");
			rate.setAmmountSell("0");
		}

		map.addAttribute(rate);

		map.addAttribute(ATTRIBUTE_APIKEY, MAPS_API_KEY);
		map.addAttribute(ATTRIBUTE_CATEGORIES, categoriesList);
		map.addAttribute("promotions", promotions);
		map.addAttribute(ATTRIBUTE_ZOOM, MAPS_ZOOM);
		map.addAttribute("itemList", util.getIdItemsFooter(company));
		map.addAttribute("menuTit", viewListMenu(company));
		map.addAttribute("footerCarousel", util.getFooterCarouselHTML());
		map.addAttribute("company", "?company=" + company);
		map.addAttribute("branch", "");

		return VIEW_NEARME;
	}
	
	public String showHome(String company) {
		String rest = "";
		// listM is a Arraylist that contains the elements the structure class
		ArrayList<Section> listM = new ArrayList<Section>();
		// listMenu is a ArrayList that return the elements should view in the
		// menu the page html
		Structure structure=null;
		try {
			structure = sectionWsClient.getStructureSite(company);
		} catch (Exception e) {
			fileLog.error("Structure error "+e.toString());
			// TODO: handle exception
		}
		// fill the listM with the each section elements the menu
		try {
			listM = structure.getConsultStructureSiteMsjRestType().getSection();
		} catch (Exception e) {
			fileLog.error("Structure errors "+e.toString());
			// TODO: handle exception
		}
		List<Section> listItemFooter= new ArrayList<Structure.ConsultStructureSiteMsjRestType.Section>();
		for (int x = 0; x < listM.size(); x++) {
			Section listMTemp = listM.get(x);
			if (listMTemp.getSectionFather().contains("-1")||listMTemp.getSectionFather().contains("0")) {
				if (listMTemp.getTypeSection().getTypeSection().contains("Pagina")||listMTemp.getTypeSection().getTypeSection().contains("Menu")) {
					if(listMTemp.getTitle().contains("Home")){
						if(listMTemp.getEstatus().contains("P")){
							ContentSection contentSection=sectionWsClient.getContentSection(listMTemp.getCode(),company);
							if(contentSection.getConsultContentSectionMsjRespType()!=null){
								ConsultSectionContentMsjRespType contentType=contentSection.getConsultContentSectionMsjRespType();
								if(contentType!=null){
									if(contentType.getSection()!=null){
										rest = contentType.getSection().getContent();
										return rest;
									}
								}
							}
						}
					}
				}
			}
		}
		return rest;
	}

}
