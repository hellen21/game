package cr.fi.grupomutual.website.controllers;


import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import groovy.util.logging.Log4j;

import org.apache.http.HttpRequest;
import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import cr.fi.grupomutual.website.entities.ContactResponse;
import cr.fi.grupomutual.website.entities.ContactResponse.ContactResponseWS.Contacts;
import cr.fi.grupomutual.website.entities.JobArea;
import cr.fi.grupomutual.website.entities.Rate;
import cr.fi.grupomutual.website.utilities.Utils;
import cr.fi.grupomutual.website.ws.ContantWsClient;
import cr.fi.grupomutual.website.ws.HomeWsClient;
import cr.fi.grupomutual.website.ws.SectionWsClient;

@Log4j
@Controller
public class ContactController extends Utils{

	@Autowired
	HomeWsClient homeWsClient;
	@Autowired
	SectionWsClient sectionWsClient;
	@Autowired
	Utils util;
	@Autowired
	ContantWsClient contantWsClient;
	
	Logger fileLog = Logger.getLogger("file");
	
	@RequestMapping(value = "/contactenos")
	public String contact(Model model, HttpServletRequest request){
		String company = (String) request.getSession().getAttribute("company");
		Rate rate=null;
		// Call the service RateChange, to get the rate change value
		try {
			 rate = homeWsClient.getRateChangeValue();
		} catch (Exception e) {
			fileLog.error("Rate error "+e.toString());
			rate= new Rate();
			rate.setAmmountBuy("0");
			rate.setAmmountSell("0");
		}
		model.addAttribute(rate);
		model.addAttribute("itemList", util.getIdItemsFooter(company));
		model.addAttribute("menuTit", util.viewListMenu(company));
		model.addAttribute("footerCarousel", util.getFooterCarouselHTML());
		List<JobArea> jobsAndEmails = parseJob(contantWsClient.consultContact());
		request.getSession().setAttribute("listEmails", jobsAndEmails);
		model.addAttribute("jobsAndEmails", jobsAndEmails);
		model.addAttribute("company", "?company="+company);
		return "contact";

	}
	
	
	@RequestMapping(value = "/sendNotification")
	public @ResponseBody String sendNotification(Model model, HttpServletRequest request,  @RequestParam(value="AreaTrabajo") String value){
	
		@SuppressWarnings("unchecked")
		List<JobArea> jobsAndEmails= (List<JobArea>) request.getSession().getAttribute("listEmails");
		
		String name= request.getParameter("name");
		String factory= request.getParameter("factory");
		String address= request.getParameter("address");
		String cedula= request.getParameter("ced");
		String phone= request.getParameter("phone");
		String inputEmail= request.getParameter("inputEmail");
		String comment= request.getParameter("comment");
		
		@SuppressWarnings("unused")
		JobArea emails= new JobArea();
		for(JobArea job: jobsAndEmails){
			if(job.getContactType().equals(value)){
				emails= job;
			}
		}
		String comments="&Aacute;rea de trabajo: "+value+"<br>"+"Nombre: "+name+"<br>"+"Empresa: "+factory+"<br>"+"Direcci&oacute;n: "+address+"<br>"+"C&eacute;dula: "+cedula+"<br>"+"Tel&eacute;fono: "+phone+"<br>"+"Email: "+inputEmail+"<br>"+"Comentario: "+comment;
		
		contantWsClient.sendComments(name, comments, emails);
		
		return "";
	}
	
	int salt = 12345;
	
	@RequestMapping(value="/validateInputsCaptcha", method=RequestMethod.GET)
	public @ResponseBody String createSection( @RequestParam(value="value") String value, @RequestParam(value="text") String text) {
	
		if (rpHash(value + salt).equals(text)) {
			
		}
		return null;
	}
	
	private String rpHash( String value) { 
	    int hash = 5381; 
	    value = value.toUpperCase(); 
	    for(int i = 0; i < value.length(); i++) { 
	        hash = ((hash << 5) + hash) + value.charAt(i); 
	    } 
	    return String.valueOf(hash); 
	} 
	
	private List<JobArea> parseJob(ContactResponse contacts){
		List<JobArea> listJobs= new ArrayList<JobArea>();
		
		List<Contacts> listContacts=contacts.getConsultSectionContentMsjSolTipo().getContact();
		for(Contacts element:listContacts){
			JobArea jobTemp= new JobArea();
			if(element.getIdContact()!=null){
				jobTemp.setIdContant(element.getIdContact());
				}
			if(element.getIdCanal()!=null){
				jobTemp.setIdCanal(element.getIdCanal());
			}
			if(element.getContactType()!=null){
				jobTemp.setContactType(element.getContactType());
			}
			if(element.getEmails()!=null){
				jobTemp.setEmails(element.getEmails());
			}
			listJobs.add(jobTemp);
		}
		
		return listJobs;
	}
}
